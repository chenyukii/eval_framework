遥感大模型多任务评估框架（构建中）
python eval_main.py --config eval_config_dir.json

python -m eval_framework.eval_main --config eval_framework/config/cfg_count.json


#  a  file for eval_framwork design
# 多模态遥感大模型多任务指标评估需求文档

## 一、文档目的

明确多模态遥感大模型多任务指标评估的全流程规范，包括任务定义、数据格式、指标体系、代码要求、运行环境等核心内容，为模型评估落地、多模型横向对比及模型迭代优化提供标准化指导，确保评估过程可复现、结果可信赖。

## 二、核心目标

1. 实现**多任务统一评估**：覆盖图像级、区域级任务，预留像素级任务扩展接口，支持不同任务的差异化指标计算。
2. 保障**评估结果精准**：沿用行业标准指标与计算逻辑，处理特殊场景（如模型输出异常、无效样本），确保指标可信度。
3. 提供**高灵活度工具**：支持实时评估与批量评估、多种输入输出格式、自定义路径配置，适配不同使用场景。
4. 输出**结构化成果**：生成可直接复用的指标报告与可视化图表，支撑模型性能分析与迭代决策。

## 三、范围界定

### （一）评估任务清单（按层级分类）

| 任务层级 |   任务名称   | 任务描述                                           | 模型输入                                     | 模型输出格式                                                 |
| :------: | :----------: | -------------------------------------------------- | -------------------------------------------- | ------------------------------------------------------------ |
|  图像级  |   图片检索   | 从多个图像中筛选含指定类别目标的图像，返回图像序号 | 多个 base64 格式图像 + 检索指令              | 有序序号字符串（如 “1,2”），序号以逗号分隔                   |
|  图像级  |   图片分类   | 识别遥感图像的所有地物类别                         | 单张 base64 格式图像 + 分类指令              | 类别字符串（如 “car;truck”），多类别以分号分隔               |
|  图像级  |     VQA1     | 判断图像中是否存在指定类别目标                     | 单张 base64 格式图像 + 问答指令              | 二选一字符串（“Yes” 或 “No”）                                |
|  图像级  |     VQA2     | 统计图像中指定类别目标的数量                       | 单张 base64 格式图像 + 问答指令              | 数字字符串（如 “3”）                                         |
|  图像级  |     VQA3     | 输出图像中指定类别目标的所有水平边界框             | 单张 base64 格式图像 + 问答指令              | 水平边界框集合（如 “`<box><x1><y1><x2><y2></box><box>...</box>`”），无空格分隔 |
|  图像级  |     计数     | 统计图像中指定类别目标的数量                       | 单张 base64 格式图像 + 计数指令              | 数字字符串（如 “36”）                                        |
|  图像级  | 简洁图片描述 | 生成 15-20 个英文单词的遥感图像描述                | 单张 base64 格式图像 + 描述指令              | 英文文本字符串（15-20 词）                                   |
|  图像级  | 详细图片描述 | 生成 30-50 个英文单词的遥感图像描述                | 单张 base64 格式图像 + 描述指令              | 英文文本字符串（30-50 词）                                   |
|  区域级  | 水平区域分类 | 识别指定水平边界框内目标的类别                     | 单张 base64 格式图像 + 水平边界框 + 分类指令 | 类别字符串（如 “vehicle”）                                   |
|  区域级  | 旋转区域分类 | 识别指定旋转边界框内目标的类别                     | 单张 base64 格式图像 + 旋转边界框 + 分类指令 | 类别字符串（如 “car”）                                       |
|  区域级  | 水平区域检测 | 输出图像中指定类别目标的所有水平边界框及数量       | 单张 base64 格式图像 + 检测指令              | 数量 + 水平边界框集合（如 “28 `<box><x1><y1><x2><y2></box><box>...</box>`”），无空格分隔 |
|  区域级  | 旋转区域检测 | 输出图像中指定类别目标的所有旋转边界框及数量       | 单张 base64 格式图像 + 检测指令              | 数量 + 旋转边界框集合（如 “29 `<quad><x1><y1><x2><y2><x3><y3><x4><y4></quad><quad>...</quad>`”），无空格分隔 |
|  区域级  |   视觉定位   | 输出图像中符合文本描述的水平边界框                 | 单张 base64 格式图像 + 视觉定位指令          | 水平边界框（如 “`<box><x1><y1><x2><y2></box>`”）             |
|  区域级  |   区域描述   | 生成 15-20 个英文单词的指定旋转区域描述            | 单张 base64 格式图像 + 旋转边界框 + 描述指令 | 英文文本字符串（15-20 词）                                   |
|  像素级  |   像素分类   |                                                    |                                              | 类别字符串（如"car"）                                        |
|  像素级  |   语义分割   |                                                    |                                              | 多边形边界框集合（如 “`<poly><10><20><30><40><50><60><70><80><90><100><110><120><130><140><150><160></poly>`”），无空格分割 |
|  像素级  |   实例分割   |                                                    |                                              | 多边形边界框集合（如 “`<poly><10><20><30><40><50><60><70><80><90><100><110><120><130><140><150><160></poly>`”），无空格分隔 |
|  像素级  |   变化检测   |                                                    |                                              | 多边形边界框集合（如“`<dot><10><20><30><40><50><60><70><80><90><100><110><120><130><140><150><160></dot>`”），无空格分隔 |
|  像素级  |  细粒度识别  |                                                    |                                              | 类别字符串（如"car"）                                        |

### （二）数据范围

1. 数据载体：所有标注数据存储为 TXT 文件，每行 1 个 JSON 字典。
2. 数据规模：每个任务约 20 万条样本，支持批量加载与处理。
3. 图像格式：模型输入图像以 base64 编码格式存储在`frames`字段中，支持 RGB、红外等多模态图像。
4. 数据字段：每条样本包含`prompt`（模型输入指令）、`frames`（base64 编码图像）、`gt`（正确答案）、`task`（任务类别）、`source`（原始图像路径，便于错误追溯）。

### （三）模型适配

1. 模型类型：多模态遥感视觉语言模型（VLM），输入为 “base64 图像 + 文本指令”，输出为纯文本字符串。
2. 输出特性：模型输出格式与标注数据中`gt`字段格式完全一致，支持实时输出或保存为 TXT/JSON 文件。

## 四、详细需求

### （一）数据格式规范

#### 1. 标注数据（TXT-JSON）格式

每条样本为 UTF-8 编码的 JSON 字符串，字段要求如下：

```json
{
  "prompt": "模型输入的文本指令（字符串）",
  "frames": "base64编码的图像（单图为单个字符串，多图为字符串数组）",
  "gt": "正确答案（字符串，格式与对应任务输出一致）",
  "task": "任务类别（字符串，与任务清单中名称一致，如“图片检索”“水平区域检测”）",
  "source": "原始图像路径（字符串，多图用逗号分隔，便于错误查找）"
}
```

- 约束：`gt`字段格式与对应任务输出格式一致。

#### 2. 模型输出格式

- 实时输出：纯文本字符串，格式与对应任务`gt`字段完全一致（如水平区域检测输出 “28 `<box>...</box>`”）。
- 文件存储输出：
  - 模型输出文件命名：训练样本名_output.txt。例如训练样本ASLTID_person_batch_3_prompt.txt，模型输出保存文件ASLTID_person_batch_3_prompt_output.txt
  - TXT 格式：每行 1 个 JSON 字典，包含`sample_id`（样本唯一标识）、`task`（任务类别）、`model_output`（模型输出文本）、`source`（原始图像路径）。
  - JSON 格式：数组结构，每个元素包含上述相同字段，文件编码为 UTF-8。

#### 3. 输入数据关联规则

- 批量评估时，标注文件与模型输出文件通过`文件名`进行样本配对，确保一一对应(一个文件的sourcce可能和多个文件的source相同，使用按文件名关联是更严谨，可维护方便修改的，后面根据实际情况再修改)。
- 单样本评估时，直接输入`gt`字符串与`model_output`字符串，需手动指定任务类别。

### （二）指标体系规范

#### 1. 任务 - 指标绑定关系（沿用行业标准）

| 任务名称                | 核心指标           | 辅助指标                            | 指标计算标准                                                 |      |      |
| ----------------------- | ------------------ | ----------------------------------- | ------------------------------------------------------------ | ---- | ---- |
| 图片检索                | 准确率（Accuracy） | 召回率（Recall）、F1 分数           | 准确率 = 检索正确的样本数 / 总样本数；召回率 = 检索正确的目标样本数 / 所有真实目标样本数 |      |      |
| 图片分类                | 准确率（Accuracy） | 宏平均 F1（Macro-F1）、宏平均召回率 | 准确率 = 类别预测完全匹配的样本数 / 总样本数；多类别需全部匹配计为正确 |      |      |
| VQA1（Yes/No）          | 准确率（Accuracy） | -                                   | 预测结果与`gt`完全一致计为正确                               |      |      |
| VQA2（数量问答）        | 准确率（Accuracy） | 绝对误差（Absolute Error）          | 预测数值与`gt`完全一致计为正确；绝对误差 =预测值 - 真实值    |      |      |
| VQA3（边界框问答）      | AP@IoU=0.5         | AP@IoU=0.75                         | 按 VOC 标准计算平均精度，IoU≥0.5 判定为匹配                  |      |      |
| 目标计数                | 准确率（Accuracy） | 平均绝对误差（MAE）                 | 预测数值与`gt`完全一致计为正确；MAE = 所有样本绝对误差的平均值 |      |      |
| 图片描述（简洁 / 详细） | CIDEr、ROUGE-L     | BLEU-4、METEOR                      | CIDEr 基于 TF-IDF 权重计算文本相似度；ROUGE-L 基于最长公共子序列 |      |      |
| 水平 / 旋转区域分类     | 准确率（Accuracy） | 宏平均 F1、混淆矩阵                 | 预测类别与`gt`完全一致计为正确                               |      |      |
| 水平 / 旋转区域检测     | AP@IoU=0.5         | AP@IoU=0.75                         | 水平边界框计算轴对齐 IoU，旋转边界框计算旋转 IoU，基于多边形顶点的 IoU 计算 |      |      |
| 视觉定位                | AP@IoU=0.5         | AP@IoU=0.25                         | 预测边界框与`gt`边界框 IoU≥0.5 判定为正确，计算平均精度      |      |      |
| 区域描述                | CIDEr、ROUGE-L     | BLEU-4、METEOR                      | 同图片描述类指标计算标准                                     |      |      |

#### 2. 指标计算要求

- 指标计算用业界通用的官方实现，有官方库的就用官方库，不用自己简化或者造轮子
- 结果精度：所有指标保留 2 位小数。
- 批量计算：支持对单个任务的所有样本批量计算指标，输出整体均值与样本级明细。
- 标签处理：暂不启用标签映射，后续可通过配置文件添加标签字典（如 “car” 与 “vehicle” 统一映射）。

### （三）特殊场景处理规则

1. 模型输出异常：
   - 输出为空、格式错误（如边界框缺少坐标、类别拼写错误）时，判定为预测错误。
   - 错误信息记录：将异常样本的`source`（原始图像路径）、`task`（任务类别）、错误类型（如 “输出为空”“边界框格式错误”）保存至指定路径的`error_log.txt`文件。
2. 无效样本处理：
   - 标注数据中`gt`字段格式错误、`task`字段未定义时，判定为无效样本。
   - 处理逻辑：跳过该样本，不参与指标计算，将无效原因与`source`字段记录至`invalid_sample_log.txt`文件。
3. 多目标 / 多参考场景：
   - 检测任务无真实目标（`gt`中无边界框）时，模型预测有目标判定为 FP（假阳性），无预测判定为 TN（真阴性）。
   - 描述任务暂不支持多参考`gt`，仅按单个`gt`计算指标。
   - 多目标检测时，模型输出的数量少于真实数量怎么办，模型输出的数量比真是数量多怎么办

### （四）代码功能要求

#### 1. 核心功能模块

- 数据加载与解析模块：
  - 支持加载 TXT 格式标注文件与模型输出文件（TXT/JSON），批量解析 JSON 字典。
  - 提供样本配对功能，通过`文件名`关联标注与模型输出。
- 指标计算模块：
  - 按任务拆分独立函数（如`calculate_detection_ap`“`calculate_caption_cider`”），模块化设计。
  - 支持核心指标与辅助指标的灵活开关（通过配置文件设置）。
  - 内置 IoU 计算（轴对齐 / 旋转）、文本相似度计算（CIDEr/ROUGE）等工具函数。
- 结果输出模块：
  - 结构化报告：输出 JSON/CSV 格式指标报告，包含整体指标、任务细分指标、样本级明细。
  - 可视化图表：生成柱状图（多模型对比）、雷达图（单模型多任务）、热力图（指标分布），支持保存为 PNG/PDF 格式（分辨率≥1080p）。
  - 日志记录：输出错误日志与无效样本日志，保存至指定路径。
- 扩展功能模块：
  - 任务扩展：支持通过配置文件新增任务（无需修改核心代码），需指定任务名称、指标函数、输入输出解析规则。
  - 格式扩展：支持自定义标注字段映射（通过`field_mapping.json`配置，如 “ground_truth” 映射为 “gt”）。

#### 2. 代码调用与运行要求

- 调用方式：

  - 批量评估：支持通过参数指定标注文件路径、模型输出文件路径、输出目录、是否计算辅助指标、是否生成可视化，示例命令：

    ```bash
    python eval_main.py --anno-path ./anno_files/ --model-result-path ./model_output/ --output-dir ./eval_results --calc-aux-metric True --vis True
    ```

    

  - 实时函数调用：提供 API 接口，支持导入评估函数，输入`gt`字符串、`model_output`字符串、任务类别，返回最终指标

    
  
- 性能要求：

  - 内存占用：峰值内存≤8GB，支持批量处理时设置批次大小（默认批次 1000 条样本）。
  - 处理速度：单任务 1 万样本评估≤20 分钟（Intel i7-12700H + 16GB 内存）。
  - 每个任务的数据量有一百万，注意减少内存压力

### （五）代码规范与环境要求

#### 1. 代码规范

- 编码风格：遵循 PEP 8 规范，变量 / 函数命名清晰（如`calculate_detection_ap`而非`calc_ap`）。
- 目录结构：

```plaintext
eval_framework/
├── config/          # 配置文件目录
│   ├── task_metric.json    # 任务-指标映射配置
│   ├── field_mapping.json  # 字段映射配置
│   └── vis_config.json     # 可视化参数配置
├── data/            # 数据处理模块
│   ├── loader.py    # 文件加载与解析
│   ├── parser.py    # 模型输出解析与校验
│   └── validator.py # 数据有效性校验
├── metrics/         # 指标计算模块
│   ├── base.py      # 指标基类
│   ├── classification.py   # 分类任务指标
│   ├── detection.py # 检测任务指标
│   ├── captioning.py       # 描述任务指标
│   └── retrieval.py        # 检索任务指标
├── visualization/   # 可视化模块
│   ├── multi_model.py      # 多模型对比可视化
│   ├── single_model.py     # 单模型多任务可视化
│   └── utils.py            # 可视化工具函数
├── utils/           # 通用工具模块
│   ├── logger.py    # 日志工具
│   ├── iou_utils.py # IoU计算工具
│   └── text_metric_utils.py # 文本指标工具
├── eval_main.py     # 命令行运行主入口
├── api.py           # 实时调用API接口
├── requirements.txt # 依赖包清单
└── README.md        # 用户操作手册
```

- 注释要求：核心函数（如指标计算、数据解析）需添加文档字符串，说明功能、参数、返回值；关键逻辑（如 IoU 计算、文本相似度匹配）添加行注释。

#### 2. 运行环境

- 现在windows环境进行开发测试，测试通过后在linux服务器运行测试，代码在涉及两者代码差异时需要将linux版本代码注释掉，只显示windows版本，后续在linux环境运行时只需要取消linux版本注释，注释windows版本代码。编写测试代码时跳过base64格式的测试样例，不用检测base64。
- Python 版本：3.9.x（兼容 3.8-3.10）。
- PyTorch 版本：1.13.1（与参考论文一致）。
- 核心依赖包及版本：
  - 数据处理：json5==0.9.14、base64io==1.0.3、pandas==1.5.3。
  - 指标计算：pycocotools==2.0.6、rouge-score==0.1.2、nltk==3.8.1。
  - 可视化：matplotlib==3.7.1、seaborn==0.12.2、pillow==9.4.0。
  - 其他：loguru==0.7.0（日志工具）、tqdm==4.65.0（进度条）。
- 硬件要求：支持 CPU/GPU 运行，无强制 GPU 依赖；GPU 运行需 CUDA≥11.6。

## 五、交付物清单

| 交付物名称     | 数量 | 要求                                                         |
| -------------- | ---- | ------------------------------------------------------------ |
| 完整评估代码包 | 1 套 | 符合目录结构与代码规范，包含所有模块文件，支持命令行 / API 调用 |
| 配置文件       | 3 个 | task_metric.json、field_mapping.json、vis_config.json（含默认配置） |
| 依赖包清单     | 1 个 | requirements.txt，明确包名及版本号，无版本冲突               |
| 测试数据集     | 1 套 | 含各任务标注 TXT 文件（每个任务 100 条样本）、模型输出示例文件（TXT/JSON） |
| 测试脚本       | 1 套 | pytest 单元测试用例（覆盖核心指标计算、数据解析功能）        |
| 用户操作手册   | 1 份 | Markdown 格式，含环境搭建、代码调用示例、数据格式说明、常见问题排查 |
| 示例评估成果   | 1 套 | 测试数据集的指标报告（JSON/CSV）、可视化图表（PNG/PDF）、错误日志示例 |

## 六、后续工作指导

1. 数据准备阶段：
   - 整理所有任务的标注 TXT 文件，、`gt`格式与任务要求一致。
   - 确认模型输出存储方式（实时输出 / 文件存储），批量评估需提前按`文件名`字段整理模型输出文件。
2. 代码开发 / 部署阶段：
   - 按目录结构模块化开发，优先实现核心任务（如检测、分类）的指标计算，再扩展描述、检索类任务。
   - 开发完成后运行单元测试，验证指标计算准确性（如用测试数据集对比预期结果）。
   - 部署环境时严格按`requirements.txt`安装依赖，避免版本冲突。
3. 评估执行阶段：
   - 首次运行建议先测试少量样本（如 10 条），验证数据解析、指标计算、结果输出是否正常。
   - 批量评估时监控内存占用，若超出阈值可调整批次大小（通过命令行参数设置）。
   - 评估完成后重点分析指标报告与错误日志，定位模型薄弱任务（如小目标检测精度低）。
4. 扩展优化阶段：
   - 新增像素级任务时，在`config/task_metric.json`中配置任务 - 指标映射，新增对应指标计算函数（无需修改核心代码）。
   - 后续添加标签映射时，补充`label_mapping.json`配置文件，在数据解析模块启用标签映射逻辑。